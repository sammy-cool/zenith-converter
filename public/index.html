<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Zenith V5 Enterprise</title>
    <link rel="icon" href="/favicon.svg" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      :root {
        --primary: #58a6ff;
        --bg: #0d1117;
        --card: #161b22;
        --border: #30363d;
      }
      body {
        font-family: "Segoe UI", monospace;
        background: var(--bg);
        color: #c9d1d9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        padding: 30px;
        border-radius: 12px;
        width: 600px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
      }
      .header img {
        width: 150px;
        filter: drop-shadow(0 0 10px rgba(88, 166, 255, 0.4));
      }

      .upload-zone {
        border: 2px dashed #333;
        padding: 40px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
      }
      .upload-zone:hover {
        border-color: var(--primary);
        background: #1c1e24;
      }

      /* Dynamic Filter Area */
      #filterSection {
        display: none;
        margin-top: 20px;
        animation: slideDown 0.4s;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .filter-group {
        background: #0b0d10;
        border: 1px solid #333;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 10px;
        max-height: 150px;
        overflow-y: auto;
      }
      .filter-header {
        font-size: 12px;
        color: var(--primary);
        font-weight: bold;
        margin-bottom: 8px;
        text-transform: uppercase;
      }

      .chk-item {
        display: inline-block;
        width: 45%;
        margin-bottom: 5px;
        font-size: 13px;
      }
      .chk-item input {
        accent-color: var(--primary);
      }

      button {
        width: 100%;
        padding: 15px;
        background: #238636;
        border: none;
        color: white;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
        font-size: 16px;
      }
      button:disabled {
        background: #21262d;
        color: #555;
        cursor: not-allowed;
      }
      button.secondary {
        background: #30363d;
        margin-top: 10px;
      }

      .progress-container {
        margin-top: 20px;
        display: none;
      }
      .bar-bg {
        background: #333;
        height: 10px;
        border-radius: 5px;
        overflow: hidden;
      }
      .bar-fill {
        background: var(--primary);
        width: 0%;
        height: 100%;
        transition: width 0.3s;
      }
      .console {
        background: black;
        padding: 10px;
        font-size: 11px;
        color: #0f0;
        margin-top: 10px;
        height: 100px;
        overflow-y: auto;
        border-radius: 4px;
        border: 1px solid #333;
      }

      #finalAction {
        display: none;
        margin-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="header">
        <img src="/logo.avif" onerror="this.style.display = 'none'" />
        <h2 style="color: white; margin: 10px 0">Zenith V5 Enterprise</h2>
        <p style="font-size: 12px; color: #888">
          Dynamic Analysis & Smart Indexing
        </p>
      </div>

      <div id="step1">
        <div
          class="upload-zone"
          onclick="document.getElementById('fileIn').click()"
        >
          <div id="uploadText">ðŸ“‚ Click to Select Project ZIP</div>
          <input type="file" id="fileIn" hidden accept=".zip" />
        </div>
      </div>

      <div id="filterSection">
        <p style="font-size: 13px; text-align: center">
          Analyzing structure... Uncheck items to <b>EXCLUDE</b> them.
        </p>

        <div class="filter-header">Found File Types</div>
        <div class="filter-group" id="extList"></div>

        <div class="filter-header">Found Root Folders</div>
        <div class="filter-group" id="folderList"></div>

        <button id="convertBtn" onclick="startConversion()">
          Genererate PDF Report
        </button>
        <button class="secondary" onclick="location.reload()">Cancel</button>
      </div>

      <div class="progress-container" id="step3">
        <div class="bar-bg"><div class="bar-fill" id="bar"></div></div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 5px;
          "
        >
          <span id="statusTxt">Initializing...</span>
          <span id="pctTxt">0%</span>
        </div>
        <div class="console" id="consoleLog"></div>
      </div>

      <div id="finalAction">
        <a id="dlLink" href="#" download>
          <button>Download Report (Index on Pg 1)</button>
        </a>
        <button class="secondary" onclick="location.reload()">
          Process Another File
        </button>
      </div>
    </div>

    <script>
      let zipFile = null;
      let foundExtensions = new Set();
      let foundFolders = new Set();

      // 1. Handle File Selection & Client-Side Scan
      document
        .getElementById("fileIn")
        .addEventListener("change", async function (e) {
          if (!this.files[0]) return;
          zipFile = this.files[0];

          document.getElementById("uploadText").innerText =
            "Analyzing: " + zipFile.name + "...";

          // Use JSZip to read structure WITHOUT uploading
          try {
            const zip = await JSZip.loadAsync(zipFile);
            foundExtensions.clear();
            foundFolders.clear();

            zip.forEach((relativePath, zipEntry) => {
              if (zipEntry.dir) {
                // Get top-level folders only
                const rootFolder = relativePath.split("/")[0];
                if (rootFolder) foundFolders.add(rootFolder);
              } else {
                // Get Extensions
                const ext = relativePath.split(".").pop();
                if (ext && ext.length < 5)
                  foundExtensions.add("." + ext.toLowerCase());
              }
            });

            renderFilters();
            document.getElementById("step1").style.display = "none";
            document.getElementById("filterSection").style.display = "block";
          } catch (err) {
            alert("Error reading ZIP: " + err.message);
          }
        });

      // 2. Render Checkboxes
      function renderFilters() {
        const extDiv = document.getElementById("extList");
        const folderDiv = document.getElementById("folderList");

        // Render Extensions
        foundExtensions.forEach((ext) => {
          const isMedia = [".png", ".jpg", ".mp4", ".exe"].includes(ext);
          extDiv.innerHTML += `
                <label class="chk-item">
                    <input type="checkbox" class="filter-ext" value="${ext}" ${isMedia ? "" : "checked"}> ${ext}
                </label>`;
        });

        // Render Folders
        foundFolders.forEach((folder) => {
          const isJunk = ["node_modules", ".git", "dist", "build"].includes(
            folder,
          );
          folderDiv.innerHTML += `
                <label class="chk-item">
                    <input type="checkbox" class="filter-folder" value="${folder}" ${isJunk ? "" : "checked"}> /${folder}
                </label>`;
        });
      }

      // 3. Start Conversion
      async function startConversion() {
        document.getElementById("filterSection").style.display = "none";
        document.getElementById("step3").style.display = "block";

        // Gather Exclusions (Items UNCHECKED by user)
        const exclusions = [];

        document.querySelectorAll(".filter-ext").forEach((cb) => {
          if (!cb.checked) exclusions.push(cb.value);
        });
        document.querySelectorAll(".filter-folder").forEach((cb) => {
          if (!cb.checked) exclusions.push(cb.value);
        });

        const fd = new FormData();
        fd.append("zipfile", zipFile);
        fd.append("exclusions", JSON.stringify(exclusions));

        try {
          const res = await fetch("/convert", { method: "POST", body: fd });
          const { jobId } = await res.json();

          // Start SSE
          const es = new EventSource(`/progress/${jobId}`);
          es.onmessage = (e) => {
            const d = JSON.parse(e.data);
            document.getElementById("bar").style.width = d.percent + "%";
            document.getElementById("pctTxt").innerText = d.percent + "%";
            document.getElementById("statusTxt").innerText =
              d.status === "processing" ? "Engine Running..." : "Done";

            const log = document.createElement("div");
            log.innerText = "> " + d.message;
            const c = document.getElementById("consoleLog");
            c.appendChild(log);
            c.scrollTop = c.scrollHeight;

            if (d.status === "completed") {
              es.close();
              document.getElementById("step3").style.display = "none";
              document.getElementById("finalAction").style.display = "block";
              document.getElementById("dlLink").href = d.downloadUrl;
            }
          };
        } catch (e) {
          alert("Upload Error");
        }
      }
    </script>
  </body>
</html>
