<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zenith V6 Enterprise</title>
    <link rel="icon" href="/favicon.svg" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      :root {
        --primary: #58a6ff;
        --success: #238636;
        --bg: #0d1117;
        --card-bg: #161b22;
        --border: #30363d;
        --text-main: #c9d1d9;
        --text-muted: #8b949e;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial,
          sans-serif;
        background: var(--bg);
        color: var(--text-main);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 32px;
        border-radius: 12px;
        width: 600px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      }

      /* Logo & Header */
      .logo-box {
        text-align: center;
        margin-bottom: 24px;
      }
      .logo-box img {
        width: 80px;
        margin-bottom: 12px;
      }
      .logo-box h2 {
        margin: 0;
        font-size: 24px;
        font-weight: 600;
      }
      .logo-box p {
        color: var(--text-muted);
        font-size: 14px;
        margin-top: 8px;
      }

      /* Upload Zone */
      .upload-zone {
        border: 2px dashed var(--border);
        padding: 40px;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: rgba(255, 255, 255, 0.02);
      }
      .upload-zone:hover {
        border-color: var(--primary);
        background: rgba(88, 166, 255, 0.05);
      }

      /* Filter Section */
      #filterSection {
        display: none;
        margin-top: 20px;
        border-top: 1px solid var(--border);
        padding-top: 20px;
      }
      .filter-header {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .chk-item {
        display: flex;
        align-items: center;
        font-size: 13px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
      }
      .chk-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .chk-item input {
        margin-right: 10px;
        accent-color: var(--primary);
      }

      /* Buttons */
      button {
        width: 100%;
        padding: 12px;
        background: var(--success);
        border: none;
        color: white;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: 0.2s;
      }
      button:hover {
        opacity: 0.9;
      }
      button.secondary {
        background: var(--border);
        margin-top: 12px;
      }
      button.secondary:hover {
        background: #444;
      }

      /* ENTERPRISE PROGRESS UI */
      .progress-box {
        display: none;
        margin-top: 20px;
      }

      /* Step Wizard */
      .steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        position: relative;
      }
      .steps::before {
        content: "";
        position: absolute;
        top: 10px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--border);
        z-index: 0;
      }
      .step {
        position: relative;
        z-index: 1;
        background: var(--card-bg);
        padding: 0 10px;
        text-align: center;
      }
      .step-dot {
        width: 20px;
        height: 20px;
        background: var(--border);
        border-radius: 50%;
        margin: 0 auto 5px;
        transition: 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: var(--card-bg);
        font-weight: bold;
      }
      .step.active .step-dot {
        background: var(--primary);
        box-shadow: 0 0 10px rgba(88, 166, 255, 0.4);
      }
      .step.done .step-dot {
        background: var(--success);
      }
      .step-label {
        font-size: 11px;
        color: var(--text-muted);
      }
      .step.active .step-label {
        color: var(--primary);
        font-weight: bold;
      }

      /* Terminal Window */
      .console-window {
        background: #0d1117;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-family:
          "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        padding: 12px;
        margin-top: 15px;
      }
      .console-header {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid #21262d;
      }
      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .red {
        background: #ff5f56;
      }
      .yellow {
        background: #ffbd2e;
      }
      .green {
        background: #27c93f;
      }

      .console-logs {
        height: 120px;
        overflow-y: auto;
        color: var(--text-muted);
        scroll-behavior: smooth;
      }
      .log-line {
        margin-bottom: 4px;
        display: flex;
      }
      .log-time {
        color: #58a6ff;
        margin-right: 8px;
        opacity: 0.7;
      }
      .log-msg {
        color: #c9d1d9;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="logo-box">
        <img
          src="/logo.avif"
          alt="Zenith-Logo"
          onerror="this.style.display = 'none'"
        />
        <h2 style="color: white; margin: 10px 0">Zenith V6 Enterprise</h2>
        <p style="font-size: 13px; color: #888">
          Smart Indexing & Dynamic Analysis
        </p>
      </div>

      <div id="uploadScreen">
        <div
          class="upload-zone"
          onclick="document.getElementById('fileIn').click()"
        >
          <div id="uploadText">ðŸ“‚ Click to Analyze ZIP File</div>
          <input type="file" id="fileIn" hidden accept=".zip" />
        </div>
      </div>

      <div id="filterSection">
        <p style="font-size: 13px; color: #ccc; text-align: center">
          Analysis Complete. Uncheck items to <b>EXCLUDE</b> them.
        </p>

        <div class="filter-header">Detected File Types</div>
        <div class="filter-container" id="extList"></div>

        <div class="filter-header">Detected Root Folders</div>
        <div class="filter-container" id="folderList"></div>

        <button id="convertBtn" onclick="startConversion()">
          Generate PDF Report
        </button>
        <button class="secondary" onclick="resetUI()">Cancel & Reset</button>
      </div>

      <div class="progress-box" id="progressScreen">
        <div class="steps">
          <div class="step" id="step1">
            <div class="step-dot">1</div>
            <div class="step-label">Extract</div>
          </div>
          <div class="step" id="step2">
            <div class="step-dot">2</div>
            <div class="step-label">Analyze</div>
          </div>
          <div class="step" id="step3">
            <div class="step-dot">3</div>
            <div class="step-label">Render</div>
          </div>
          <div class="step" id="step4">
            <div class="step-dot">4</div>
            <div class="step-label">Index</div>
          </div>
        </div>

        <div class="console-window">
          <div class="console-header">
            <div class="dot red"></div>
            <div class="dot yellow"></div>
            <div class="dot green"></div>
            <span style="margin-left: 10px; color: #8b949e"
              >server-logs â€” node</span
            >
          </div>
          <div class="console-logs" id="consoleLog">
            <div class="log-line">
              <span class="log-msg">> Establishing secure connection...</span>
            </div>
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #8b949e;
          "
        >
          <span id="statusTxt">Waiting for server...</span>
          <span id="pctTxt">0%</span>
        </div>
      </div>

      <div id="finalSection">
        <a id="dlLink" href="#" download>
          <button>Download Report (Index on Pg 1)</button>
        </a>
        <button class="secondary" onclick="resetUI()">
          Process Another File
        </button>
      </div>
    </div>

    <script>
      let zipFile = null;
      let foundExtensions = new Set();
      let foundFolders = new Set();

      // --- PHASE 1: CLIENT-SIDE ANALYSIS ---
      document
        .getElementById("fileIn")
        .addEventListener("change", async function (e) {
          if (!this.files[0]) return;
          zipFile = this.files[0];

          document.getElementById("uploadText").innerText =
            "Scanning Structure: " + zipFile.name + "...";

          try {
            const zip = await JSZip.loadAsync(zipFile);
            foundExtensions.clear();
            foundFolders.clear();

            zip.forEach((relativePath, zipEntry) => {
              const parts = relativePath.split("/");

              // Identify Root Folders
              if (parts.length > 1 || zipEntry.dir) {
                if (parts[0] && parts[0] !== "." && parts[0] !== "__MACOSX")
                  foundFolders.add(parts[0]);
              }

              // Identify Extensions
              if (!zipEntry.dir) {
                const filename = parts[parts.length - 1];
                const extParts = filename.split(".");
                if (extParts.length > 1) {
                  const ext = "." + extParts.pop().toLowerCase();
                  if (ext.length < 7) foundExtensions.add(ext);
                }
              }
            });

            renderFilters();
            document.getElementById("uploadScreen").style.display = "none";
            document.getElementById("filterSection").style.display = "block";
          } catch (err) {
            alert("Error reading ZIP: " + err.message);
            resetUI();
          }
        });

      function renderFilters() {
        const extDiv = document.getElementById("extList");
        const folderDiv = document.getElementById("folderList");
        extDiv.innerHTML = "";
        folderDiv.innerHTML = "";

        // Auto-Check logic: Uncheck binaries/images by default for cleaner PDF
        foundExtensions.forEach((ext) => {
          const isMedia = [
            ".png",
            ".jpg",
            ".jpeg",
            ".gif",
            ".mp4",
            ".exe",
            ".dll",
            ".zip",
          ].includes(ext);
          const isChecked = !isMedia ? "checked" : "";
          extDiv.innerHTML += `
                <label class="chk-item">
                    <input type="checkbox" class="filter-ext" value="${ext}" ${isChecked}> ${ext}
                </label>`;
        });

        // Auto-Check logic: Uncheck system folders
        foundFolders.forEach((folder) => {
          const isJunk = [
            "node_modules",
            ".git",
            "dist",
            "build",
            ".next",
            "coverage",
          ].includes(folder);
          const isChecked = !isJunk ? "checked" : "";
          folderDiv.innerHTML += `
                <label class="chk-item">
                    <input type="checkbox" class="filter-folder" value="${folder}" ${isChecked}> /${folder}
                </label>`;
        });
      }

      // --- PHASE 2: CONVERSION ---
      async function startConversion() {
        document.getElementById("filterSection").style.display = "none";
        document.getElementById("progressScreen").style.display = "block";

        // Gather what to EXCLUDE (Unchecked items)
        const exclusions = { extensions: [], folders: [] };

        document.querySelectorAll(".filter-ext").forEach((cb) => {
          if (!cb.checked) exclusions.extensions.push(cb.value);
        });
        document.querySelectorAll(".filter-folder").forEach((cb) => {
          if (!cb.checked) exclusions.folders.push(cb.value);
        });

        const fd = new FormData();
        fd.append("zipfile", zipFile);
        fd.append("exclusions", JSON.stringify(exclusions));

        try {
          const res = await fetch("/convert", { method: "POST", body: fd });
          if (!res.ok) throw new Error("Server Error");

          const { jobId } = await res.json();

          // SSE Listener
          // Inside async function startConversion() ...

          const es = new EventSource(`/progress/${jobId}`);
          const consoleDiv = document.getElementById("consoleLog");
          const steps = [1, 2, 3, 4].map((n) =>
            document.getElementById(`step${n}`),
          );

          es.onmessage = (e) => {
            const d = JSON.parse(e.data);

            // update percentage text
            document.getElementById("pctTxt").innerText = d.percent + "%";
            document.getElementById("statusTxt").innerText = d.message;

            // SMART STEP LOGIC: Light up steps based on keywords in the message
            if (d.message.includes("Extracting")) {
              setActiveStep(0);
            } else if (
              d.message.includes("Structure") ||
              d.message.includes("Scanning")
            ) {
              setActiveStep(1);
            } else if (d.message.includes("Rendering")) {
              setActiveStep(2);
            } else if (d.message.includes("Index")) {
              setActiveStep(3);
            }

            // Add colorful log entry
            if (d.message) {
              const line = document.createElement("div");
              line.className = "log-line";
              const time = new Date().toLocaleTimeString("en-US", {
                hour12: false,
              });
              line.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-msg">${d.message}</span>`;
              consoleDiv.appendChild(line);
              consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            if (d.status === "completed") {
              es.close();
              steps.forEach((s) => s.classList.add("done")); // Mark all green
              setTimeout(() => {
                document.getElementById("progressScreen").style.display =
                  "none";
                document.getElementById("finalSection").style.display = "block";
                document.getElementById("dlLink").href = d.downloadUrl;
              }, 800);
            }

            if (d.status === "failed") {
              es.close();
              alert("Conversion Failed: " + d.message);
              resetUI();
            }
          };

          // Helper to handle visual state of dots
          function setActiveStep(index) {
            steps.forEach((step, i) => {
              if (i < index) {
                step.classList.remove("active");
                step.classList.add("done");
              } else if (i === index) {
                step.classList.add("active");
              }
            });
          }
        } catch (e) {
          alert("Upload Failed: " + e.message);
          resetUI();
        }
      }

      function resetUI() {
        zipFile = null;
        document.getElementById("fileIn").value = "";
        document.getElementById("uploadText").innerText =
          "ðŸ“‚ Click to Analyze ZIP File";

        document.getElementById("uploadScreen").style.display = "block";
        document.getElementById("filterSection").style.display = "none";
        document.getElementById("progressScreen").style.display = "none";
        document.getElementById("finalSection").style.display = "none";
        document.getElementById("consoleLog").innerHTML = "";
        document.getElementById("bar").style.width = "0%";
      }
    </script>
  </body>
</html>
